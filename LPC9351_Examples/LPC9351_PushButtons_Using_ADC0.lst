0000              1   ; This program shows how to read many push buttons using just one analog input.
0000              2   ; The idea is to make a voltage divider with many resistors and the push buttons
0000              3   ; connect the diferent voltages to an analog input.  In this example we have seven push
0000              4   ; buttons.  The diagram is in this image: push_button_adc.jpg.  The common pin of all
0000              5   ; the push buttons is connected to one of the analog input pins of ADC0.  Warning:
0000              6   ; since P2.0 and P2.1 are used with the LCD we can not use those channels with ADC0.
0000              7   ; The common input for all the push buttons is AD0DAT1 which is P1.7.
0000              8   ;
0000              9   
                 -1   $MOD9351
0000              1   ;
0000              2   ;  MOD9351: Register/bit definitions for the P89LPC9351
0000              3   ;
0000              4   ;   Copyright (C) 2009-2011  Jesus Calvino-Fraga, jesuscf@gmail.com
0000              5   ;
0000              6   ;   This library is free software; you can redistribute it and/or
0000              7   ;   modify it under the terms of the GNU Lesser General Public
0000              8   ;   License as published by the Free Software Foundation; either
0000              9   ;   version 2.1 of the License, or (at your option) any later version.
0000             10   ;
0000             11   ;   This library is distributed in the hope that it will be useful,
0000             12   ;   but WITHOUT ANY WARRANTY; without even the implied warranty of
0000             13   ;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
0000             14   ;   Lesser General Public License for more details.
0000             15   ;
0000             16   ;   You should have received a copy of the GNU Lesser General Public
0000             17   ;   License along with this library; if not, write to the Free Software
0000             18   ;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
0000             19   ;
0000             20    
0000             21   ACC             DATA  0E0H ; Accumulator
0000             22   ADCON0          DATA  08EH ; A/D control register 0
0000             23   ADCON1          DATA  097H ; A/D control register 1
0000             24   ADINS           DATA  0A3H ; A/D input select
0000             25   ADMODA          DATA  0C0H ; A/D mode register A
0000             26   BNDI1           BIT   0C7H
0000             27   BURST1          BIT   0C6H
0000             28   SCC1            BIT   0C5H
0000             29   SCAN1           BIT   0C4H
0000             30   BNDI0           BIT   0C3H
0000             31   BURST0          BIT   0C2H
0000             32   SCC0            BIT   0C1H
0000             33   SCAN0           BIT   0C0H
0000             34   ADMODB          DATA  0A1H ; A/D mode register B
0000             35   AD0BH           DATA  0BBH ; A/D_0 boundary high register
0000             36   AD0BL           DATA  0A6H ; A/D_0 boundary low register
0000             37   AD0DAT0         DATA  0C5H ; A/D_0 data register 0
0000             38   AD0DAT1         DATA  0C6H ; A/D_0 data register 1
0000             39   AD0DAT2         DATA  0C7H ; A/D_0 data register 2
0000             40   AD0DAT3         DATA  0F4H ; A/D_0 data register 3
0000             41   AD1BH           DATA  0C4H ; A/D_1 boundary high register
0000             42   AD1BL           DATA  0BCH ; A/D_1 boundary low register
0000             43   AD1DAT0         DATA  0D5H ; A/D_1 data register 0
0000             44   AD1DAT1         DATA  0D6H ; A/D_1 data register 1
0000             45   AD1DAT2         DATA  0D7H ; A/D_1 data register 2
0000             46   AD1DAT3         DATA  0F5H ; A/D_1 data register 3
0000             47   AUXR1           DATA  0A2H ; Auxiliary function register
0000             48   B               DATA  0F0H ; B register
0000             49   BRGR0           DATA  0BEH ; Baud rate generator 0 rate low
0000             50   BRGR1           DATA  0BFH ; Baud rate generator 0 rate high
0000             51   BRGCON          DATA  0BDH ; Baud rate generator 0 control
0000             52   CCCRA           DATA  0EAH ; Capture compare A control register
0000             53   CCCRB           DATA  0EBH ; Capture compare B control register
0000             54   CCCRC           DATA  0ECH ; Capture compare C control register
0000             55   CCCRD           DATA  0EDH ; Capture compare D control register
0000             56   CMP1            DATA  0ACH ; Comparator 1 control register
0000             57   CMP2            DATA  0ADH ; Comparator 2 control register
0000             58   DEECON          DATA  0F1H ; Data EEPROM control register
0000             59   DEEDAT          DATA  0F2H ; Data EEPROM data register
0000             60   DEEADR          DATA  0F3H ; Data EEPROM address register
0000             61   DIVM            DATA  095H ; CPU clock divide-by-M control
0000             62   DPH             DATA  083H ; Data pointer high
0000             63   DPL             DATA  082H ; Data pointer low
0000             64   FMADRH          DATA  0E7H ; Program flash address high
0000             65   FMADRL          DATA  0E6H ; Program flash address low
0000             66   FMCON           DATA  0E4H ; Program flash control Read
0000             67   FMDATA          DATA  0E5H ; Program flash data
0000             68   I2ADR           DATA  0DBH ; I2C-bus slave address register
0000             69   I2CON           DATA  0D8H ; I2C-bus control register
0000             70   I2EN            BIT   0DEH
0000             71   STA             BIT   0DDH
0000             72   STO             BIT   0DCH
0000             73   SI              BIT   0DBH
0000             74   AA              BIT   0DAH
0000             75   CRSEL           BIT   0D8H
0000             76   I2DAT           DATA  0DAH ; I2C-bus data register
0000             77   I2SCLH          DATA  0DDH ; Serial clock generator/SCL duty cycle register high
0000             78   I2SCLL          DATA  0DCH ; Serial clock generator/SCL duty cycle register low
0000             79   I2STAT          DATA  0D9H ; I2C-bus status register
0000             80   ICRAH           DATA  0ABH ; Input capture A register high
0000             81   ICRAL           DATA  0AAH ; Input capture A register low
0000             82   ICRBH           DATA  0AFH ; Input capture B register high
0000             83   ICRBL           DATA  0AEH ; Input capture B register low
0000             84   IEN0            DATA  0A8H ; Interrupt enable 0
0000             85   EA              BIT   0AFH
0000             86   EWDRT           BIT   0AEH
0000             87   EBO             BIT   0ADH
0000             88   ES              BIT   0ACH
0000             89   ESR             BIT   0ACH
0000             90   ET1             BIT   0ABH
0000             91   EX1             BIT   0AAH
0000             92   ET0             BIT   0A9H
0000             93   EX0             BIT   0A8H
0000             94   IEN1            DATA  0E8H ; Interrupt enable 1
0000             95   EADEE           BIT   0EFH
0000             96   EST             BIT   0EEH
0000             97   ECCU            BIT   0ECH
0000             98   ESPI            BIT   0EBH
0000             99   EC              BIT   0EAH
0000            100   EKBI            BIT   0E9H
0000            101   EI2C            BIT   0E8H
0000            102   IP0             DATA  0B8H ; Interrupt priority 0
0000            103   PWDRT           BIT   0BEH
0000            104   PBO             BIT   0BDH
0000            105   PS              BIT   0BCH
0000            106   PSR             BIT   0BCH
0000            107   PT1             BIT   0BBH
0000            108   PX1             BIT   0BAH
0000            109   PT0             BIT   0B9H
0000            110   PX0             BIT   0B8H
0000            111   IP0H            DATA  0B7H ; Interrupt priority 0 high
0000            112   IP1             DATA  0F8H ; Interrupt priority 1
0000            113   PADEE           BIT   0FFH
0000            114   PST             BIT   0FEH
0000            115   PCCU            BIT   0FCH
0000            116   PSPI            BIT   0FBH
0000            117   PC_             BIT   0FAH
0000            118   PKBI            BIT   0F9H
0000            119   PI2C            BIT   0F8H
0000            120   IP1H            DATA  0F7H ; Interrupt priority 1 high
0000            121   KBCON           DATA  094H ; Keypad control register
0000            122   KBMASK          DATA  086H ; Keypad interrupt mask register
0000            123   KBPATN          DATA  093H ; Keypad pattern register
0000            124   OCRAH           DATA  0EFH ; Output compare A register high
0000            125   OCRAL           DATA  0EEH ; Output compare A register low
0000            126   OCRBH           DATA  0FBH ; Output compare B register high
0000            127   OCRBL           DATA  0FAH ; Output compare B register low
0000            128   OCRCH           DATA  0FDH ; Output compare C register high
0000            129   OCRCL           DATA  0FCH ; Output compare C register low
0000            130   OCRDH           DATA  0FFH ; Output compare D register high
0000            131   OCRDL           DATA  0FEH ; Output compare D register low
0000            132   P0              DATA  080H ; Port 0
0000            133   T1              BIT   087H
0000            134   KB7             BIT   087H
0000            135   CMP_1           BIT   086H
0000            136   KB6             BIT   086H
0000            137   CMPREF          BIT   085H
0000            138   KB5             BIT   085H
0000            139   CIN1A           BIT   084H
0000            140   KB4             BIT   084H
0000            141   CIN1B           BIT   083H
0000            142   KB3             BIT   083H
0000            143   CIN2A           BIT   082H
0000            144   KB2             BIT   082H
0000            145   CIN2B           BIT   081H
0000            146   KB1             BIT   081H
0000            147   CMP_2           BIT   080H
0000            148   KB0             BIT   080H
0000            149   P1              DATA  090H ; Port 1
0000            150   OCC             BIT   097H
0000            151   OCB             BIT   096H
0000            152   RST             BIT   095H
0000            153   INT1            BIT   094H
0000            154   INT0            BIT   093H
0000            155   SDA             BIT   093H
0000            156   T0              BIT   092H
0000            157   SCL             BIT   092H
0000            158   RXD             BIT   091H
0000            159   TXD             BIT   090H
0000            160   P2              DATA  0A0H ; Port 2
0000            161   ICA             BIT   0A7H
0000            162   OCA             BIT   0A6H
0000            163   SPICLK          BIT   0A5H
0000            164   SS              BIT   0A4H
0000            165   MISO            BIT   0A3H
0000            166   MOSI            BIT   0A2H
0000            167   OCD             BIT   0A1H
0000            168   ICB             BIT   0A0H
0000            169   P3              DATA  0B0H ; Port 3
0000            170   XTAL1           BIT   0B1H
0000            171   XTAL2           BIT   0B0H
0000            172   P0M1            DATA  084H ; Port 0 output mode 1
0000            173   P0M2            DATA  085H ; Port 0 output mode 2
0000            174   P1M1            DATA  091H ; Port 1 output mode 1
0000            175   P1M2            DATA  092H ; Port 1 output mode 2
0000            176   P2M1            DATA  0A4H ; Port 2 output mode 1
0000            177   P2M2            DATA  0A5H ; Port 2 output mode 2
0000            178   P3M1            DATA  0B1H ; Port 3 output mode 1
0000            179   P3M2            DATA  0B2H ; Port 3 output mode 2
0000            180   PCON            DATA  087H ; Power control register
0000            181   PCONA           DATA  0B5H ; Power control register A
0000            182   PSW             DATA  0D0H ; Program status word
0000            183   CY              BIT   0D7H
0000            184   AC              BIT   0D6H
0000            185   F0              BIT   0D5H
0000            186   RS1             BIT   0D4H
0000            187   RS0             BIT   0D3H
0000            188   OV              BIT   0D2H
0000            189   F1              BIT   0D1H
0000            190   P               BIT   0D0H
0000            191   PT0AD           DATA  0F6H ; Port 0 digital input disable
0000            192   RSTSRC          DATA  0DFH ; Reset source register
0000            193   RTCCON          DATA  0D1H ; RTC control
0000            194   RTCH            DATA  0D2H ; RTC register high
0000            195   RTCL            DATA  0D3H ; RTC register low
0000            196   SADDR           DATA  0A9H ; Serial port address register
0000            197   SADEN           DATA  0B9H ; Serial port address enable
0000            198   SBUF            DATA  099H ; Serial Port data buffer register
0000            199   SCON            DATA  098H ; Serial port control
0000            200   SM0             BIT   09FH
0000            201   FE              BIT   09FH
0000            202   SM1             BIT   09EH
0000            203   SM2             BIT   09DH
0000            204   REN             BIT   09CH
0000            205   TB8             BIT   09BH
0000            206   RB8             BIT   09AH
0000            207   TI              BIT   099H
0000            208   RI              BIT   098H
0000            209   SSTAT           DATA  0BAH ; Serial port extended status register
0000            210   SP              DATA  081H ; Stack pointer
0000            211   SPCTL           DATA  0E2H ; SPI control register
0000            212   SPSTAT          DATA  0E1H ; SPI status register
0000            213   SPDAT           DATA  0E3H ; SPI data register
0000            214   TAMOD           DATA  08FH ; Timer 0 and 1 auxiliary mode
0000            215   TCON            DATA  088H ; Timer 0 and 1 control
0000            216   TF1             BIT   08FH
0000            217   TR1             BIT   08EH
0000            218   TF0             BIT   08DH
0000            219   TR0             BIT   08CH
0000            220   IE1             BIT   08BH
0000            221   IT1             BIT   08AH
0000            222   IE0             BIT   089H
0000            223   IT0             BIT   088H
0000            224   TCR20           DATA  0C8H ; CCU control register 0
0000            225   PLEEN           BIT   0CFH
0000            226   HLTRN           BIT   0CEH
0000            227   HLTEN           BIT   0CDH
0000            228   ALTCD           BIT   0CCH
0000            229   ALTAB           BIT   0CBH
0000            230   TDIR2           BIT   0CAH
0000            231   TMOD21          BIT   0C9H
0000            232   TMOD20          BIT   0C8H
0000            233   TCR21           DATA  0F9H ; CCU control register 1
0000            234   TH0             DATA  08CH ; Timer 0 high
0000            235   TH1             DATA  08DH ; Timer 1 high
0000            236   TH2             DATA  0CDH ; CCU timer high
0000            237   TICR2           DATA  0C9H ; CCU interrupt control register
0000            238   TIFR2           DATA  0E9H ; CCU interrupt flag register
0000            239   TISE2           DATA  0DEH ; CCU interrupt status encode register
0000            240   TL0             DATA  08AH ; Timer 0 low
0000            241   TL1             DATA  08BH ; Timer 1 low
0000            242   TL2             DATA  0CCH ; CCU timer low
0000            243   TMOD            DATA  089H ; Timer 0 and 1 mode
0000            244   TOR2H           DATA  0CFH ; CCU reload register high
0000            245   TOR2L           DATA  0CEH ; CCU reload register low
0000            246   TPCR2H          DATA  0CBH ; Prescaler control register high
0000            247   TPCR2L          DATA  0CAH ; Prescaler control register low
0000            248   TRIM            DATA  096H ; Internal oscillator trim register
0000            249   WDCON           DATA  0A7H ; Watchdog control register
0000            250   WDL             DATA  0C1H ; Watchdog load
0000            251   WFEED1          DATA  0C2H ; Watchdog feed 1
0000            252   WFEED2          DATA  0C3H ; Watchdog feed 2
0000            253   BODCFG          XDATA 0FFC8H ; BOD configuration register
0000            254   CLKCON          XDATA 0FFDEH ; CLOCK Control register
0000            255   PGACON1         XDATA 0FFE1H ; PGA1 control register
0000            256   PGACON1B        XDATA 0FFE4H ; PGA1 control register B
0000            257   PGA1TRIM8X16X   XDATA 0FFE3H ; PGA1 trim register
0000            258   PGA1TRIM2X4X    XDATA 0FFE2H ; PGA1 trim register
0000            259   PGACON0         XDATA 0FFCAH ; PGA0 control register
0000            260   PGACON0B        XDATA 0FFCEH ; PGA0 control register B
0000            261   PGA0TRIM8X16X   XDATA 0FFCDH ; PGA0 trim register
0000            262   PGA0TRIM2X4X    XDATA 0FFCCH ; PGA0 trim register
0000            263   RTCDATH         XDATA 0FFBFH ; Real-time clock data register high
0000            264   RTCDATL         XDATA 0FFBEH ; Real-time clock data register low
0000             11   
0000             12   XTAL EQU 7373000
0000             13   BAUD EQU 115200
0000             14   BRVAL EQU ((XTAL/BAUD)-16)
0000             15   
0000             16   CSEG at 0x0000
0000 020507      17   ljmp     MainProgram
0003             18   
0030             19   DSEG at 0x30
0030             20   x:   ds 4
0034             21   y:   ds 4
0038             22   bcd: ds 5
003D             23   
003D             24   
0000             25   BSEG
0000             26   mf: dbit 1
0001             27   PB0: dbit 1 ; Variable to store the state of pushbutton 0 after calling ADC_to_PB below
0002             28   PB1: dbit 1 ; Variable to store the state of pushbutton 1 after calling ADC_to_PB below
0003             29   PB2: dbit 1 ; Variable to store the state of pushbutton 2 after calling ADC_to_PB below
0004             30   PB3: dbit 1 ; Variable to store the state of pushbutton 3 after calling ADC_to_PB below
0005             31   PB4: dbit 1 ; Variable to store the state of pushbutton 4 after calling ADC_to_PB below
0006             32   PB5: dbit 1 ; Variable to store the state of pushbutton 5 after calling ADC_to_PB below
0007             33   PB6: dbit 1 ; Variable to store the state of pushbutton 6 after calling ADC_to_PB below
0008             34   
0003             35   cseg
0003             36   ; These 'equ' must match the wiring between the microcontroller and the LCD!
0003             37   LCD_RS equ P0.5
0003             38   LCD_RW equ P0.6
0003             39   LCD_E  equ P0.7
0003             40   LCD_D4 equ P1.2
0003             41   LCD_D5 equ P1.3
0003             42   LCD_D6 equ P1.4
0003             43   LCD_D7 equ P1.6
0003             44   BUTTON equ P3.0
                546   $LIST
                 47   $LIST
0328             49   
0328             50   
0328             51   Wait10us:
0328 7812        52       mov R0, #18
032A D8FE        53       djnz R0, $ ; 2 machine cycles-> 2*0.27126us*18=10us
032C 22          54            ret
032D             55   putchar:
032D 109902      56            jbc     TI,putchar_L1
0330 80FB        57            sjmp putchar
0332             58   putchar_L1:
0332 F599        59            mov     SBUF,a
0334 22          60            ret
0335             61            
0335             62   getchar:
0335 109802      63            jbc     RI,getchar_L1
0338 80FB        64            sjmp getchar
033A             65   getchar_L1:
033A E599        66            mov     a,SBUF
033C 22          67            ret
033D             68   
033D             69   Wait1S:
033D 7A28        70            mov R2, #40
033F 79FA        71   M3:      mov R1, #250
0341 78B8        72   M2:      mov R0, #184
0343 D8FE        73   M1:      djnz R0, M1 ; 2 machine cycles-> 2*0.27126us*184=100us
0345 D9FA        74            djnz R1, M2 ; 100us*250=0.025s
0347 DAF6        75            djnz R2, M3 ; 0.025s*40=1s
0349 22          76            ret
034A             77   
034A             78   InitSerialPort:
034A 75BD00      79            mov     BRGCON,#0x00
034D 75BF00      80            mov     BRGR1,#high(BRVAL)
0350 75BE30      81            mov     BRGR0,#low(BRVAL)
0353 75BD03      82            mov     BRGCON,#0x03 ; Turn-on the baud rate generator
0356 759852      83            mov     SCON,#0x52 ; Serial port in mode 1, ren, txrdy, rxempty
0359 759100      84            mov     P1M1,#0x00 ; Enable pins RxD and TXD
035C 759200      85            mov     P1M2,#0x00 ; Enable pins RxD and TXD
035F 22          86            ret
0360             87   
0360             88   InitADC0:
0360             89            ; ADC0_0 is connected to P1.7
0360             90            ; ADC0_1 is connected to P0.0
0360             91       ; Configure pins P1.7 and P0.0  as inputs
0360 438401      92       orl P0M1, #00000001b
0363 5385FE      93       anl P0M2, #11111110b
0366 439180      94       orl P1M1, #10000000b
0369 53927F      95       anl P1M2, #01111111b
036C 43A403      96       orl P2M1, #00000011b
036F 53A5FC      97       anl P2M2, #11111100b
0372             98            ; Setup ADC0
0372 D2C2        99            setb BURST0 ; Autoscan continuos conversion mode
0374 75A120     100            mov     ADMODB,#0x20 ;ADC0 clock is 7.3728MHz/2
0377 75A30F     101            mov     ADINS,#0x0F ; Select four channels of ADC0 for conversion
037A 758E05     102            mov     ADCON0,#0x05 ; Enable the converter and start immediately
037D            103            ; Wait for first conversion to complete
037D            104   InitADC0_L1:
037D E58E       105            mov     a,ADCON0
037F 30E3FB     106            jnb     acc.3,InitADC0_L1
0382 22         107            ret
0383            108   
0383 30313233   109   HexAscii: db '0123456789ABCDEF'
     34353637
     38394142
     43444546
0393            110   SendTemp:
0393 900383     111            mov dptr, #HexAscii 
0396            112            
0396 E539       113            mov a, bcd+1
0398 C4         114            swap a
0399 540F       115            anl a, #0xf
039B 93         116            movc a, @a+dptr
039C 12032D     117            lcall putchar
039F E539       118            mov a, bcd+1
03A1 540F       119            anl a, #0xf
03A3 93         120            movc a, @a+dptr
03A4 12032D     121            lcall putchar
03A7            122   
03A7 742E       123            mov a, #'.'
03A9 12032D     124            lcall putchar
03AC            125   
03AC E538       126            mov a, bcd+0
03AE C4         127            swap a
03AF 540F       128            anl a, #0xf
03B1 93         129            movc a, @a+dptr
03B2 12032D     130            lcall putchar
03B5 E538       131            mov a, bcd+0
03B7 540F       132            anl a, #0xf
03B9 93         133            movc a, @a+dptr
03BA 12032D     134            lcall putchar
03BD            135            
03BD 740D       136            mov a, #'\r'
03BF 12032D     137            lcall putchar
03C2 740A       138            mov a, #'\n'
03C4 12032D     139            lcall putchar   
03C7 22         140            ret
03C8            141            
03C8            142   SendHex:
03C8 7430       143            mov a, #'0'
03CA 12032D     144            lcall putchar
03CD 7478       145            mov a, #'x'
03CF 12032D     146            lcall putchar
03D2 900383     147            mov dptr, #HexAscii 
03D5 E5F0       148            mov a, b
03D7 C4         149            swap a
03D8 540F       150            anl a, #0xf
03DA 93         151            movc a, @a+dptr
03DB 12032D     152            lcall putchar
03DE E5F0       153            mov a, b
03E0 540F       154            anl a, #0xf
03E2 93         155            movc a, @a+dptr
03E3 12032D     156            lcall putchar
03E6 7420       157            mov a, #' '
03E8 12032D     158            lcall putchar
03EB 22         159            ret
03EC            160            
03EC            161   SendString:
03EC E4         162       clr a
03ED 93         163       movc a, @a+dptr
03EE 6006       164       jz SendString_L1
03F0 12032D     165       lcall putchar
03F3 A3         166       inc dptr
03F4 80F6       167       sjmp SendString  
03F6            168   SendString_L1:
03F6 22         169            ret
03F7            170   
03F7            171   ADC_to_PB:
03F7 D207       172            setb PB6
03F9 D206       173            setb PB5
03FB D205       174            setb PB4
03FD D204       175            setb PB3
03FF D203       176            setb PB2
0401 D202       177            setb PB1
0403 D201       178            setb PB0
0405            179            ; Check PB6
0405 C3         180            clr c
0406 E5C5       181            mov a, AD0DAT0
0408 94C4       182            subb a, #(206-10) ; 2.8V=216*(3.3/255); the -10 is to prevent false readings
040A 4003       183            jc ADC_to_PB_L6
040C C207       184            clr PB6
040E 22         185            ret
040F            186   ADC_to_PB_L6:
040F            187            ; Check PB5
040F C3         188            clr c
0410 E5C5       189            mov a, AD0DAT0
0412 94AF       190            subb a, #(185-10) ; 2.4V=185*(3.3/255); the -10 is to prevent false readings
0414 4003       191            jc ADC_to_PB_L5
0416 C206       192            clr PB5
0418 22         193            ret
0419            194   ADC_to_PB_L5:
0419            195            ; Check PB4
0419 C3         196            clr c
041A E5C5       197            mov a, AD0DAT0
041C 9490       198            subb a, #(154-10) ; 2.0V=154*(3.3/255); the -10 is to prevent false readings
041E 4003       199            jc ADC_to_PB_L4
0420 C205       200            clr PB4
0422 22         201            ret
0423            202   ADC_to_PB_L4:
0423            203            ; Check PB3
0423 C3         204            clr c
0424 E5C5       205            mov a, AD0DAT0
0426 9471       206            subb a, #(123-10) ; 1.6V=123*(3.3/255); the -10 is to prevent false readings
0428 4003       207            jc ADC_to_PB_L3
042A C204       208            clr PB3
042C 22         209            ret
042D            210   ADC_to_PB_L3:
042D            211            ; Check PB2
042D C3         212            clr c
042E E5C5       213            mov a, AD0DAT0
0430 9452       214            subb a, #(92-10) ; 1.2V=92*(3.3/255); the -10 is to prevent false readings
0432 4003       215            jc ADC_to_PB_L2
0434 C203       216            clr PB2
0436 22         217            ret
0437            218   ADC_to_PB_L2:
0437            219            ; Check PB1
0437 C3         220            clr c
0438 E5C5       221            mov a, AD0DAT0
043A 9433       222            subb a, #(61-10) ; 0.8V=61*(3.3/255); the -10 is to prevent false readings
043C 4003       223            jc ADC_to_PB_L1
043E C202       224            clr PB1
0440 22         225            ret
0441            226   ADC_to_PB_L1:
0441            227            ; Check PB1
0441 C3         228            clr c
0442 E5C5       229            mov a, AD0DAT0
0444 9414       230            subb a, #(30-10) ; 0.4V=30*(3.3/255); the -10 is to prevent false readings
0446 4003       231            jc ADC_to_PB_L0
0448 C201       232            clr PB0
044A 22         233            ret
044B            234   ADC_to_PB_L0:
044B            235            ; No pusbutton pressed  
044B 22         236            ret
044C            237   
044C            238   Display_PushButtons_ADC:
044C C0E0       239            push acc
044E 7401       239            mov a, #1
0450 14         239            dec a
0451 12009B     239            lcall ?Set_Cursor_2 ; Select column and row
0454 D0E0       239            pop acc
0456 7430       240            mov a, #'0'
0458 A207       241            mov c, PB6
045A 3400       242            addc a, #0
045C 120051     243       lcall ?WriteData     
045F 7430       244            mov a, #'0'
0461 A206       245            mov c, PB5
0463 3400       246            addc a, #0
0465 120051     247       lcall ?WriteData     
0468 7430       248            mov a, #'0'
046A A205       249            mov c, PB4
046C 3400       250            addc a, #0
046E 120051     251       lcall ?WriteData     
0471 7430       252            mov a, #'0'
0473 A204       253            mov c, PB3
0475 3400       254            addc a, #0
0477 120051     255       lcall ?WriteData     
047A 7430       256            mov a, #'0'
047C A203       257            mov c, PB2
047E 3400       258            addc a, #0
0480 120051     259       lcall ?WriteData     
0483 7430       260            mov a, #'0'
0485 A202       261            mov c, PB1
0487 3400       262            addc a, #0
0489 120051     263       lcall ?WriteData     
048C 7430       264            mov a, #'0'
048E A201       265            mov c, PB0
0490 3400       266            addc a, #0
0492 120051     267       lcall ?WriteData     
0495 22         268            ret
0496            269   
0496 41444330   270   Title: db 'ADC0 push buttons', 0
     20707573
     68206275
     74746F6E
     7300
04A8 0D0A4144   271   InitialMessage: db '\r\nADC0 push buttons.  The push buttons voltage divider is connected to P1.7\r\n', 0
     43302070
     75736820
     62757474
     6F6E732E
     20205468
     65207075
     73682062
     7574746F
     6E732076
     6F6C7461
     67652064
     69766964
     65722069
     7320636F
     6E6E6563
     74656420
     746F2050
     312E370D
     0A00
04F6 20202020   272   blank: db '                ', 0
     20202020
     20202020
     20202020
     00
0507            273   MainProgram:
0507 75817F     274       mov SP, #0x7F
050A            275   
050A            276       ; Configure all the ports in bidirectional mode:
050A 758400     277       mov P0M1, #00H
050D 758500     278       mov P0M2, #00H
0510 759100     279       mov P1M1, #00H
0513 759200     280       mov P1M2, #00H ; WARNING: P1.2 and P1.3 need 1kohm pull-up resistors!
0516 75A400     281       mov P2M1, #00H
0519 75A500     282       mov P2M2, #00H
051C 75B100     283       mov P3M1, #00H
051F 75B200     284       mov P3M2, #00H
0522            285            
0522 12034A     286            lcall InitSerialPort
0525 120360     287            lcall InitADC0
0528            288            
0528 12005B     289       lcall LCD_4BIT
052B            290       ; For convenience a few handy macros are included in 'LCD_4bit_LPC9351.inc':
052B C0E0       291            push acc
052D 7401       291            mov a, #1
052F 14         291            dec a
0530 12009D     291            lcall ?Set_Cursor_1 ; Select column and row
0533 D0E0       291            pop acc
0535 C083       292            push dph
0537 C082       292            push dpl
0539 C0E0       292            push acc
053B 900496     292            mov dptr, #Title
053E 120090     292            lcall ?Send_Constant_String
0541 D0E0       292            pop acc
0543 D082       292            pop dpl
0545 D083       292            pop dph
0547            293   
0547 12033D     294            lcall Wait1S ; Wait a bit so PUTTy has a chance to start
054A 9004A8     295            mov dptr, #InitialMessage
054D 1203EC     296            lcall SendString
0550            297   
0550            298   forever_loop:
0550            299       ; Send the conversion results via the serial port to putty.
0550 740D       300            mov a, #'\r' ; move cursor all the way to the left
0552 12032D     301       lcall putchar
0555            302       ; Display converted value from P1.7
0555 85C5F0     303            mov     b, AD0DAT0
0558 1203C8     304            lcall SendHex
055B            305            
055B 85C6F0     306            mov     b, AD0DAT1
055E 1203C8     307            lcall SendHex
0561            308            
0561            309            
0561 753000     310            mov x+0, #low (0 % 0x10000) 
0564 753100     310            mov x+1, #high(0 % 0x10000) 
0567 753200     310            mov x+2, #low (0 / 0x10000) 
056A 753300     310            mov x+3, #high(0 / 0x10000) 
056D 85C630     311       mov x+0, AD0DAT1
0570 7FFF       312            mov R7, #255
0572 120328     313       lcall Wait10us
0575            314   accumulate_loop:
0575 85C634     315       mov y+0, AD0DAT1
0578 753500     316       mov y+1, #0
057B 753600     317       mov y+2, #0
057E 753700     318       mov y+3, #0
0581 12017D     319       lcall add32
0584 120328     320       lcall Wait10us
0587 DFEC       321            djnz R7, accumulate_loop
0589            322            
0589            323            ; Now divide by 16 (2^4)
0589 753410     324            mov y+0, #low (16 % 0x10000) 
058C 753500     324            mov y+1, #high(16 % 0x10000) 
058F 753600     324            mov y+2, #low (16 / 0x10000) 
0592 753700     324            mov y+3, #high(16 / 0x10000) 
0595 1202BF     325            lcall div32
0598            326            ; x has now the 12-bit representation of the temperature
0598            327            
0598            328            ; Convert to temperature (C)
0598 7534F8     329            mov y+0, #low (43000 % 0x10000) 
059B 7535A7     329            mov y+1, #high(43000 % 0x10000) 
059E 753600     329            mov y+2, #low (43000 / 0x10000) 
05A1 753700     329            mov y+3, #high(43000 / 0x10000)  ; Vref is 3.3V
05A4 120232     330            lcall mul32
05A7 7534FF     331            mov y+0, #low (((1<<12)-1) % 0x10000) 
05AA 75350F     331            mov y+1, #high(((1<<12)-1) % 0x10000) 
05AD 753600     331            mov y+2, #low (((1<<12)-1) / 0x10000) 
05B0 753700     331            mov y+3, #high(((1<<12)-1) / 0x10000)  ; 2^12-1
05B3 1202BF     332            lcall div32
05B6 7534A4     333            mov y+0, #low (27300 % 0x10000) 
05B9 75356A     333            mov y+1, #high(27300 % 0x10000) 
05BC 753600     333            mov y+2, #low (27300 / 0x10000) 
05BF 753700     333            mov y+3, #high(27300 / 0x10000) 
05C2 12019E     334            lcall sub32
05C5            335            
05C5 1200B8     336            lcall hex2bcd
05C8            337            
05C8 120393     338            lcall SendTemp 
05CB            339            
05CB 1203F7     340            lcall ADC_to_PB
05CE            341            
05CE 20B012     342            jb BUTTON, next
05D1 C002       343            push AR2
05D3 7A32       343            mov R2, #50
05D5 12000C     343            lcall ?Wait_Milli_Seconds
05D8 D002       343            pop AR2         
05DA 20B006     344            jb BUTTON, next
05DD 12044C     345            lcall Display_PushButtons_ADC
05E0            346            
05E0            347   
05E0            348            
05E0 020550     349            ljmp forever_loop
05E3            350   
05E3            351   next:
05E3 C0E0       352            push acc
05E5 7401       352            mov a, #1
05E7 14         352            dec a
05E8 12009B     352            lcall ?Set_Cursor_2 ; Select column and row
05EB D0E0       352            pop acc
05ED C083       353            push dph
05EF C082       353            push dpl
05F1 C0E0       353            push acc
05F3 9004F6     353            mov dptr, #blank
05F6 120090     353            lcall ?Send_Constant_String
05F9 D0E0       353            pop acc
05FB D082       353            pop dpl
05FD D083       353            pop dph
05FF 020550     354       ljmp forever_loop
0602            355   
0602            356   end
